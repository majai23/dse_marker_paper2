<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DSE Feedback Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1100px;
      margin: auto;
    }
    textarea, input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 14px;
    }
    button {
      background-color: #1e40af;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    pre {
      background-color: #f3f4f6;
      padding: 15px;
      border-radius: 5px;
      white-space: pre-wrap;
    }
    .split-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
  </style>
</head>
<body>
<h1>DSE Writing Feedback Tool</h1>

<label for="question">Writing Question</label>
<input id="question" placeholder="e.g. Should school uniforms be mandatory?" />

<label for="studentWriting">Your Full Writing</label>
<textarea id="studentWriting" rows="12" placeholder="Paste or type your full writing here..."></textarea>

<label for="feedbackMode">Feedback Mode</label>
<select id="feedbackMode">
  <option value="quick">Quick Feedback</option>
  <option value="detailed">Detailed Feedback (Paragraph by Paragraph)</option>
</select>

<button onclick="analyzeWriting()">üîç Analyze Writing</button>
<button onclick="summarizeScores()">üß† Summarize Band Scores</button>

<pre id="feedbackOutput">Feedback will appear here...</pre>

<div class="split-grid">
  <div>
    <button onclick="rewrite('5')">üìù Rewrite to Level 5</button>
    <pre id="rewrite5"></pre>
  </div>
  <div>
    <button onclick="rewrite('5**')">üìù Rewrite to Level 5**</button>
    <pre id="rewrite5star"></pre>
  </div>
</div>

<script>
let cachedFeedback = [];

async function analyzeWriting() {
  const writing = document.getElementById("studentWriting").value;
  const question = document.getElementById("question").value;
  const mode = document.getElementById("feedbackMode").value;
  const feedbackEl = document.getElementById("feedbackOutput");

  feedbackEl.innerText = "‚è≥ Generating feedback...";

  if (mode === "quick") {
    const res = await fetch("/api/bands", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ writing, question, paperType: "Part A", mode: "quick" })
    });
    const data = await res.json();
    feedbackEl.innerText = data.bandAnalysis || "‚ö†Ô∏è No feedback returned.";
  } else {
    const paragraphs = writing.split(/\n{2,}/).filter(p => p.trim());
    cachedFeedback = [];
    feedbackEl.innerText = "";
    for (let i = 0; i < paragraphs.length; i++) {
      feedbackEl.innerText += `\nüîé Analyzing paragraph ${i + 1}...\n`;
      const res = await fetch("/api/bands-paragraph", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paragraph: paragraphs[i], position: i === 0 ? "introduction" : i === paragraphs.length - 1 ? "conclusion" : "body" })
      });
      const data = await res.json();
      cachedFeedback.push(data.paragraphAnalysis);
      feedbackEl.innerText += data.paragraphAnalysis + "\n\n";
    }
  }
}

async function summarizeScores() {
  if (!cachedFeedback.length) return alert("‚ö†Ô∏è Run detailed feedback first.");
  const feedbackEl = document.getElementById("feedbackOutput");
  feedbackEl.innerText += "\nüß† Summarizing band scores...\n";
  const res = await fetch("/api/bands-summarize", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paragraphFeedback: cachedFeedback.join("\n\n") })
  });
  const data = await res.json();
  feedbackEl.innerText += data.bandAnalysis || "‚ö†Ô∏è No summary returned.";
}

async function rewrite(level) {
  const writing = document.getElementById("studentWriting").value;
  const target = level === '5' ? document.getElementById("rewrite5") : document.getElementById("rewrite5star");
  target.innerText = "‚è≥ Rewriting...";
  const res = await fetch("/api/rewrite", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ original: writing, level })
  });
  const data = await res.json();
  target.innerText = data.writing || "‚ö†Ô∏è Rewrite failed.";
}
</script>
</body>
</html>
